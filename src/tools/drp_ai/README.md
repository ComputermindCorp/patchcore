# for DRP-AI
This is the procedure for generating the memory bank file used in the PatchCore sample application for Renesas DRP-AI(RZ-V2H).

Renesas社製DRP-AI用のPatchCoreサンプルアプリで使用するmemorybankファイルを生成する手順です。

## setup
download onnx file.
```bash
cd models/patch_core/backborn/model
wget https://github.com/ComputermindCorp/assets/releases/download/v1.0.0/resnet18_features.onnx
wget https://github.com/ComputermindCorp/assets/releases/download/v1.0.0/resnet18_features_quantization.onnx
```

## create memorybank
RZ/V2H uses quantized weights. Therefore, when creating memory banks in scripts in this repository, quantized CNN models are used.<br>
Please refer to [resnet18_quantization_onnx_wood.yaml](../../cfg/train/resnet18_quantization_onnx_wood.yaml) for the configuration yaml during training.

RZ/V2Hは量子化された重みを使用します。そのため、このリポジトリのスクリプトでメモリバンクを作成する際には、量子化されたCNNモデルを使用します。<br>
学習の設定yamlは[resnet18_quantization_onnx_wood.yaml](../../cfg/train/resnet18_quantization_onnx_wood.yaml)を参考にしてください。

```cfg/train/resnet18_quantization_onnx_wood.yaml
backborn_id: resnet18_quantization_onnx
```

Please refer to [README.md](../../../README.md) for execution of training.<br>
学習の実行方法は[README.md](../../../README.md)を参照してください。

### coreset sampling ratio
As the data size and computation time of the memory banks storing patch features can become very large due to the increasing number of training data,<br>
a coreset sampling mechanism is used to reduce the size of the memory banks while maintaining performance.<br>
学習データが増加すると、メモリバンクに格納するパッチ特徴量が増え計算時間も大きくなってしまいます。<br>
そのためコアセットサンプリングメカニズムを使用して、パフォーマンスを維持しつつメモリバンクのサイズを削減します。

The post-processing time of the PatchCore sample application depends on the size of the memorybank,<br>
Refer to the table below to set the core set sampling ratio when creating the memorybank.<br>
PatchCoreサンプルアプリの後処理時間はメモリバンクのサイズに依存します。<br>
下記の表を参考に、メモリバンク作成時のコアセットサンプリング比率を設定してください。

**Note:** The table below shows the figures when validated on wood training data.<br>
下記の表は木材の学習データで検証した際の数値です。

| Arch | coreset<br>sampling ratio | f1-score | memorybank size |
| ---- | :-----------------------: | -------: | --------------: | 
| ResNet50 | 0.1 | 0.9373 | 18033, 1536 |
| ResNet50 | 0.01 | 0.9373 | 3607, 1536 |
| ResNet50 | 0.005 | 0.9373 | 902, 1536 |
| ResNet18 | 0.1 | 0.9373 | 18033,  384 |
| ResNet18 | 0.01 | 0.9373 | 1804,  384 |
| ResNet18 | 0.005 | 0.9062 | 902,  384 |
| ResNet18 | 0.002 | 0.8750 | 361,  384 |
| ResNet18 | 0.0002 | 0.9373 | 37,  384 |

## convert memorybank file
Convert the memory bank files generated by the scripts in this repository to work with the sample programs for DRP-AI.<br>
DRP-AI用サンプルプログラムで動作させるために、本リポジトリのスクリプトで生成されたメモリバンクファイルを変換します。

```bash
python convert_memorybank_torch2binary.py input_path output_path
```

### ex
```bash
python convert_memorybank_torch2binary.py \
    ../../data/weights/resnet18_quantization_onnx_size224_param_0.1_9_wood.pth \
    test.bin
```
